<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>peekis</title>
<!-- jQuery -->
<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="../../js/jquery.number.js"></script>

<!-- 부트스트랩 -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" >
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

<!-- Isotope -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.2/isotope.pkgd.min.js"></script>

<!-- Packery -->
<script src="https://npmcdn.com/packery@2.0.0/dist/packery.pkgd.min.js"></script>

<!-- imagesLoaded -->
<script src="https://npmcdn.com/imagesloaded@4.1/imagesloaded.pkgd.js"></script>

<!-- sweetalert -->
<script src="../../js/sweetalert-dev.js"></script>
<link rel="stylesheet" style="text/css" href="../../css/sweetalert.css" />

<script type="text/javascript" src="../../js/common.js"></script>

<!-- 헤더푸터 위치 페이지 사이즈  조절 -->
<link rel="stylesheet" style="text/css" href="../../css/global.css"/>
<!-- css -->
<link rel="stylesheet" style="text/css" href="../../css/common.css" />
<link rel="stylesheet" style="text/css" href="../../css/header.css" />
<link rel="stylesheet" style="text/css" href="../../css/footer.css" />
<link rel="stylesheet" style="text/css" href="../../css/btn-orange.css" />
<link rel="stylesheet" style="text/css" href="../../css/main.css" />
<link rel="stylesheet" style="text/css" href="../../css/myList.css" />
<link rel="stylesheet" style="text/css" href="../../css/profile.css" />


</head>
<body>
	<header id="header"></header>
	
	<section>
	
		<div id="user-profile"></div>
		
		<div class="main">
				<div class="item_container">
					<div id="pageNo" style="display: none;">1</div>
					<div id="UserNo" style="display: none;">0</div>
					<div id="friendNo" style="display: none;">0</div>
				</div>
		</div>
		
		
		<!-- item 기본폼 -->
		<div class="cloneMainContents" style="display: none;">
			<div class="item">
				<div class="product">
					<img src="../../image/005.jpg" />
					<input type="hidden" class="no" value="00">
					<input type="hidden" class="uno" value="00">
					<div class="mask">
						<div class="icon">
							<button class="btn btn-orange">
								<span class="glyphicon glyphicon-send"></span>
							</button>
							<button class="btn btn-orange plus">
								<span class="glyphicon glyphicon-plus"></span>
							</button>
							<button class="detail btn btn-orange">상세보기</button>
						</div>
					</div>
				</div>
				<div class="pro">
					<img src="../../image/pro1.jpg" class="img-circle userPho">
						<div class="user_id">아이디는여덟자임</div>
					<span class="glyphicon glyphicon-folder-open"></span>
					<div class="user_wish">폴더이름여덟자임</div>
					<div class="heart"></div>
					<div class="undoheart"></div>
				</div>
			</div>
		</div>


	</section>
		
	<footer id="footer"></footer>


<script> 
$(document).ready(function() {
	var $container = $('.item_container');
		$container.isotope({
			itemSelector : '.item',
			percentPosition : true
		});
          
	var sort = function(){
		$container.imagesLoaded(function() {
		$container.isotope();
		});
	}
	var friendNo = getParameter(document.location.href).fNo;
	$("#friendNo").text(friendNo);
    
	/* 위시리스트 목록 불러오기  */		
	nextPage(1, friendNo);
          
	$(window).scroll(function(){
		var scrollHeight = $(window).scrollTop() + $(window).height();
		var documentHeight = $(document).height();
		if(scrollHeight >= documentHeight -100){
			console.log("스크롤 이벤트 발생");
			var pageNo = Number($('#pageNo').text()) +1;
			nextPage(pageNo, friendNo);
		}
	});
          
	function nextPage(pageNo, friendNo){
		$.getJSON('/peekis/main/ajax/friendList.do',{pageNo : pageNo, fNo : friendNo}, function(resultObj) {
			$("#UserNo").text(resultObj.loginUser.uNo);
			console.log(resultObj);
			for (var wish of resultObj.data){
				$('#pageNo').text(pageNo);
  				var cloneContent = $('.cloneMainContents > div').clone();
  				cloneContent.addClass(wish.no+'');
  				cloneContent.find('.no').val(wish.no);
  				cloneContent.find('.uno').val(wish.uno);
  				var path = wish.path;
  				if(path.startsWith('http://') == false){
  					path = filePath + path;
  				}
  				cloneContent.find('img:first').attr('src', path);
  				cloneContent.find('.userPho').attr('src', filePath + wish.userPho);
  				cloneContent.find('.user_id').html(wish.userName);
  				cloneContent.find('.user_wish').html(wish.categoryName);
  				$items = $(cloneContent);
  				$container.append( $items ).isotope( 'appended', $items );			
			}
			sort();
  			for (var like of resultObj.like){
  				$('.' + like).find('.undoheart').css('display','block');
  				$('.' + like).find('.heart').css('display','none');
  			}  			
  			for (var send of resultObj.send){
  				$('.' + send).find('.plus').attr('status',true);
  			}
   		});
	}
	
	
	/* 상세정보 가져오기 */
	$container.on( 'click', '.detail', function() {
		var wishNo = $(this).closest('.item').find('.no').val();
		var uNo = Number($('#UserNo').text());
				
		$.getJSON('/peekis/main/ajax/detail.do', {no : wishNo, uno: uNo}, function( resultObj ) {
			var wish = resultObj.data;
			var cList = resultObj.commentList;
			console.log(wish);				
			if(cList.length>0){					
				console.log("cList : ", cList);				
				var html=""
				for(var i=0; i<cList.length;i++){			
					if(uNo==cList[i].uNo){
						if(cList[i].userPho==null){
							html += "<img src='../header/img/profileAvatar.jpg' class='img-circle' style='height: 30px; width: 30px;'></img>"
						    html += "&nbsp;<a>"+ cList[i].userName +"</a>"
						    html += "&nbsp;<span>"+ cList[i].cont +"</span>&nbsp;<span id='commentDelBtn'> &times; </span></br>"
						}else{
						    html += "<img src="+ filePath + cList[i].userPho +" class='img-circle' style='height: 30px; width: 30px;'></img>"
						    html += "&nbsp;<a>"+ cList[i].userName +"</a>"
						    html += "&nbsp;<span>"+ cList[i].cont +"</span>&nbsp;<span id='commentDelBtn'> &times; </span></br>"
						}
					}
					else{
						if(cList[i].userPho==null){
							html += "<img src='../header/img/profileAvatar.jpg' class='img-circle' style='height: 30px; width: 30px;'></img>"
						    html += "&nbsp;<a>"+ cList[i].userName +"</a>"
						    html += "&nbsp;<span>"+ cList[i].cont +"</span></br>"
						}else{
						    html += "<img src="+ filePath + cList[i].userPho +" class='img-circle' style='height: 30px; width: 30px;'></img>"
						    html += "&nbsp;<a>"+ cList[i].userName +"</a>"
						    html += "&nbsp;<span>"+ cList[i].cont +"</span></br>"
						}
					}
				}				
				$("#tab1").html(html);				
			}
				
			$("#detailmodal-no").html( wish.no );
			$("#detailmodal-uno").html( wish.uno );
			var path = wish.path;
			if(path.startsWith('http://') == false){
				path = filePath + path;
			}							
			$("#detailmodal-pro").attr('src', filePath + wish.userPho);
			$(".modal-user_id").html(wish.userName);	
			$(".modal-user_wish").html(wish.categoryName);	
			$("#detailmodal-image").attr("src", path );
			$("#detailmodal-title").html( wish.title );			
			$("#detailmodal-content").html( wish.content );
			$("#detailmodal-price").html('&#8361;&nbsp;' + $.number(wish.price));
			$("#detailmodal-url").attr("onclick", "window.open('" + wish.url + "')");
			$("#detailmodal-tag").html("");
			$('#detailmodal').modal();
			$(".follow").css("display","block");
			if(resultObj.followerCheck == 1 ){
				$(".follow").text("언팔로우");
			}
			if($("#detailmodal-uno").text() == $('#UserNo').text()){
				$(".follow").css("display","none");
			}
		});
	});
	
	
		
	/* 좋아요 토글 이벤트 */
	$(document).on('click', '.heart', function(){
		console.log('좋아요 이벤트 발생');
		var wishNo = $(this).closest('.item').find('.no').val();
		var uNo = $('#UserNo').text();
	    $.getJSON('/peekis/main/ajax/addLike.do', {wno : wishNo, uno : uNo}, function(resultObj) {
		    var result = resultObj.ajaxResult;
		    if(result.status == 'success'){
				$('.' + wishNo).find('.heart').toggleClass('toggle').show().fadeToggle(1000),
			    setTimeout(function(){
			    $('.' + wishNo).find('.heart').toggleClass('toggle');  
				},1000), 
			    $('.' + wishNo).find('.undoheart').hide().fadeToggle(1000);
		   }else{
		    	swal('좋아요 추가에 실패하였습니다.');
		   }
	   });
	});

	$(document).on('click', '.undoheart', function(){
		console.log('좋아요 취소이벤트 발생');
		var wishNo = $(this).closest('.item').find('.no').val();
		var uNo = $('#UserNo').text();
	    $.getJSON('/peekis/main/ajax/deleteLike.do', {wno : wishNo, uno : uNo}, function(resultObj) {
	    	var result = resultObj.ajaxResult;
        	console.log(result);
	    	if(result.status == 'success'){
		    	$('.' + wishNo).find('.undoheart').toggleClass('toggle').show().fadeToggle(1000),
		        setTimeout(function(){
		        $('.' + wishNo).find('.undoheart').toggleClass('toggle');  
				},1000), 
		        $('.' + wishNo).find('.heart').hide().fadeToggle(1000);
	    	}else{
	    		swal('좋아요 삭제에 실패하였습니다.');
	    	}
	    });
	});
	
	
	
	
	/* 팔로우 하기 */
	$(document).on("click", ".follow", function(){
		var wishUserNo = $(this).closest('.modal-content').find('.uno').text();
		var uNo = $('#UserNo').text();
   		if($(".follow").text() == "팔로우"){
			$.getJSON('/peekis/main/ajax/follower.do', {wishUserNo : wishUserNo, uno : uNo}, 
				function( resultObj ) {
					swal("팔로우 성공!", "유저와 친구가 되었습니다!", "success");
					$(".follow").text("언팔로우");
					console.log(resultObj);
				});
   		}else if($(".follow").text() == "언팔로우"){
			$.getJSON('/peekis/main/ajax/unfollower.do', {wishUserNo : wishUserNo, uno : uNo}, 
				function( resultObj ) {
					swal("팔로우 삭제!", "친구가 삭제되었습니다!", "error");
					$(".follow").text("팔로우");
					console.log(resultObj);
			});
   		}
   });
	
});
</script>

<!-- 푸터 관련 스트립트 -->
<script>
var didScroll;
var lastScrollTop = 0;
var delta = 5;
var navbarHeight = $('footer').outerHeight();

$(window).scroll(function(event){
    didScroll = true;
});

setInterval(function() {
    if (didScroll) {
        hasScrolled();
        didScroll = false;
    }
}, 250);

function hasScrolled() {
    var st = $(this).scrollTop();
    
    if(Math.abs(lastScrollTop - st) <= delta)
        return;
    
    if (st > lastScrollTop && st > navbarHeight){
        $('footer').removeClass('nav-down').addClass('nav-up');
        $('#demoTop').show();
        
    } else {
        if(st + $(window).height() < $(document).height()) {
            $('footer').removeClass('nav-up').addClass('nav-down');
        }
    }
    lastScrollTop = st;
}
</script>
<script>
	$("#header").load("../header/header.html");
	$("#footer").load("../footer/footer.html");
	$("#user-profile").load("../profile/profile.html");
</script>
</body>
</html>