<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- 위 3개의 메타 태그는 *반드시* head 태그의 처음에 와야합니다; 어떤 다른 콘텐츠들은 반드시 이 태그들 *다음에* 와야 합니다 -->
<title>메인 화면</title>

<!-- jQuery -->
<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="../../js/jquery.number.js"></script>

<!-- bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

<!-- Isotope -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.2/isotope.pkgd.min.js"></script>

<!-- btn-orange -->
<link rel="stylesheet" href="../../css/btn-orange.css">

<!-- CSS -->
<link rel="stylesheet" href="../../css/main.css">


<!-- header, footer -->
<link rel="stylesheet" style="text/css" href="../../css/header.css" />
<link rel="stylesheet" style="text/css" href="../../css/footer.css" />
<link rel="stylesheet" style="text/css" href="../../css/global.css" />

<!-- imagesLoaded -->
<script src="https://npmcdn.com/imagesloaded@4.1/imagesloaded.pkgd.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>

<!-- sweetalert -->
<script src="../../js/sweetalert-dev.js"></script>
<link rel="stylesheet" style="text/css" href="../../css/sweetalert.css" />


</head>
<body>
	<header id="header"></header>

	<div class="filter">
		<div id="filters" class="btn-group">
			<button class="button is-checked btn btn-orange" data-filter="*">모두 보기</button>
			<button class="button btn btn-orange" data-filter=".friend">친구</button>
		</div>
	</div>

	<div class="main">
		<div class="item_container">
			<div id="pageNo" style="display: none;">1</div>
			<div id="UserNo" style="display: none;">0</div>
		</div>

		<div class="cloneMainContents" style="display: none;">
			<div class="item">
				<div class="product">
					<img src="../../image/no_image(235x400).png" />
					<input type="hidden" class="no" value="00">
					<input type="hidden" class="uno" value="00">
					<div class="mask">
						<div class="icon">
							<button class="btn btn-orange plus">
								<span class="glyphicon glyphicon-plus"></span>
							</button>
							<button class="detail btn btn-orange">상세보기</button>
						</div>
					</div>
				</div>
				<div class="pro">
					<img src="../../image/pro1.jpg" class="img-circle userPho">
						<div class="user_id">아이디는여덟자임</div>
					<span class="glyphicon glyphicon-folder-open"></span>
					<div class="user_wish">폴더이름여덟자임</div>
					<div class="heart">
						<figure id="likeAmountLoc"><figcaption id="likeAmount"></figcaption></figure>
					</div>
					<div class="undoheart">
						<figure id="likeAmountLoc"><figcaption id="likeAmount"></figcaption></figure>
					</div>
				</div>
			</div>
		</div>
		
	<!-- DetailModal -->
		<div class="item-modal modal fade" id="detailmodal" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<div class="modal-pro">
							<img src="../../image/pro1.jpg" class="img-circle detailmodal-pro">
							<div class="modal-user_id">아이디는여덟자임</div>
							<span class="glyphicon glyphicon-folder-open"></span>
							<div class="modal-user_wish">폴더이름여덟자임</div>
						    <button class="btn btn-orange follow" id="detailFollowBtn">팔로우</button>
						</div>
						<button type="button" class="btn btn-orange" data-dismiss="modal">닫기</button>
					</div>
					<div class="modal-body">
						<input type="hidden" class="no" id="detailmodal-no">
						<input type="hidden" class="uno" id="detailmodal-uno">
						<div class="item-image">
							<img src="../../image/no_image(450X450).png" alt="" id="detailmodal-image">
							<figure id="tagCaption"><figcaption id="tagCaptionText"><a></a></figcaption></figure>
						</div>

						<div class="item-content">
							<div class="item-title" id="detailmodal-title">title:</div>
							<br />
							<div class="item-subtitle" id="detailmodal-content">content:</div>
							<div class="item-costi-box">
								<div class="price" id="detailmodal-price">&#8361; price:</div>
							</div>
							<br />
							<div class="item-button-box">
								<button class="btn btn-default" id="detailmodal-url">
									<span class="glyphicon glyphicon-credit-card"> </span>구매하러 가기
								</button>
								<a href="#capymodal" data-toggle="modal"><button class="btn btn-default" id="detailSendBtn">담아가기</button></a>
								<button class="btn btn-default">좋아요</button>
							</div>
							<br />
							<div>
								<div class="btn-pref btn-group btn-group-justified btn-group-lg" role="group" aria-label="...">
									<div class="btn-group" role="group">
										<button id="comment" class="btn btn-orange" href="#tab1" data-toggle="tab">
											<div class="hidden-xs">댓글&nbsp;<span id="commentLength">0</span></div>
										</button>
									</div>
									<div class="btn-group" role="group">
										<button id="send" class="btn btn-default" href="#tab2" data-toggle="tab">
											<div class="hidden-xs">담아가기&nbsp;<span id="sendLength">0</span></div>
										</button>
									</div>
									<div class="btn-group" role="group">
										<button id="like" class="btn btn-default" href="#tab3" data-toggle="tab">
											<div class="hidden-xs">좋아요&nbsp;<span id="likeLength">0</span></div>
										</button>
									</div>
								</div>
								<div class="well">
									<div class="tab-content">
										<div class="tab-pane fade in active" id="tab1" style="overflow: auto;">
										</div>
										<div class="tab-pane fade in" id="tab2">
										</div>
										<div class="tab-pane fade in" id="tab3" style="overflow: auto;">
										</div>
									</div>
								</div>
								<div class="comment">
									<div class="comment_pro">
										<img src="../../image/pro1.jpg" class="img-circle comInputUserPho">
										<div class="col-lg-10">
											<div class="input-group">
												<input type="text" class="form-control" placeholder="댓글을 입력해주세요" id="commentText"> <span class="input-group-btn">
													<button class="btn btn-default" type="button" id="insertComment">입력</button>
												</span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<footer class="nav-down" id="footer"></footer>

	<span data-toggle="tooltip" data-placement="top" title="" id="demoTop" data-original-title="Going Up?" style="display: none;"><a href="#" style="display: block; padding: 5px;">Δ</a></span>

<script>
	$("#header").load("../header/header.html");
	$("#footer").load("../footer/footer.html");
</script>
<script>
/* 파라미터값 꺼내기 */
var getParameter = function(url) {
	var paramText = decodeURI(url).split("?")[1];
		return paramText;
};
var pageParam = getParameter(document.location.href);

/* 로그인 체크 */
$.getJSON('/peekis/main/ajax/loginCheck.do')
	.done( function(resultObj) {
		console.log('로그인체크');
		console.log(resultObj);
		if(resultObj.ajaxResult.data != null){
			var loginUser = resultObj.ajaxResult.data
			$("#dropdown-color").text(loginUser.name);
			$("#loginUser-no").text(loginUser.uNo);		
			if(loginUser.pho != null){
				$("#pImg").attr("src", filePath + loginUser.pho);
			}
			nextPage(1, pageParam);
		}else{
			location.href = contextRoot + "/auth/joinForm.html"
		}
	})
	.fail(function(){
		location.href = contextRoot + "/auth/joinForm.html"
	});

	/* 이미지 정렬 */
	var $container = $('.item_container');
		$container.isotope({
	    	itemSelector : '.item',
	        percentPosition : true,
	        masonry: { columnWidth : 1, rowHeight: 1 }
	    });
	var sort = function(){
	   $container.imagesLoaded(function() {
			$container.isotope();
	   });
	}
		
		
	/* 리스트 불러오기 */
	nextPage(1, pageParam);
			
	$(window).scroll(function(){
		var scrollHeight = $(window).scrollTop() + $(window).height();
		var documentHeight = $(document).height();
		if(scrollHeight >= documentHeight -150){
	    	console.log('스크롤 이벤트 발생');
        	var pageNo = Number($('#pageNo').text()) +1;
	    	nextPage(pageNo, pageParam);
	    }
	});
	       
	
	function nextPage(pageNo, pageParam){
		var uno = $("#loginUser-no").text();
		
		$.getJSON('/peekis/main/ajax/searchList.do',{pageNo : pageNo, tag : pageParam, uno: uno}, function(resultObj) {
			$("#UserNo").text(resultObj.loginUser.uNo);
			console.log('리스트 불러오기');
		 	console.log(resultObj);
			for (var wish of resultObj.data){
				  $('#pageNo').text(pageNo);
				  var cloneContent = $('.cloneMainContents > div').clone();
					cloneContent.addClass(wish.no+'');
					cloneContent.find('.no').val(wish.no);
					cloneContent.find('.uno').val(wish.uno);
					var path = wish.path;
					if(path.startsWith('http://') == false){
						path = filePath + path;
					}
					cloneContent.find('img:first').attr('src', path);
					if (wish.likeSts == 1){
						cloneContent.find('.undoheart').css('display','block');
						cloneContent.find('.heart').css('display','none');
					}
					if (wish.sendSts == 1){
						cloneContent.find('.plus').attr('status',true);
					}
					if (wish.uno == uno){
						cloneContent.find('.plus').css('opacity',0);
					}
					if(wish.userPho==null){
						cloneContent.find('.userPho').attr('src', '../header/img/profileAvatar.jpg');
					}else{
						cloneContent.find('.userPho').attr('src', filePath + wish.userPho);
					} 
					cloneContent.find('.user_id').html(wish.userName);
					cloneContent.find('.user_wish').html(wish.categoryName);
					//라이크 개수
					cloneContent.find('#likeAmount').text(wish.numOflNo);
					
					$items = $(cloneContent);
					$container.append( $items ).isotope( 'appended', $items );			
		  	}
			sort();
		});
	   }
     
	
	
	/* 좋아요 추가 이벤트 */
	$(document).on('click', '.heart', function(){
			console.log('좋아요 이벤트 발생');
			var wishNo = $(this).closest('.item').find('.no').val();
			var uNo = $('#loginUser-no').text();
		    var	numOfLikeval =	$(this).find("#likeAmount").text();
		    var numOfLike = $(this).next("div").find("#likeAmount");
		    
		    
	    	$.getJSON('/peekis/main/ajax/addLike.do', {wno : wishNo, uno : uNo}, function(resultObj) {
	    		var result = resultObj.ajaxResult;
				if(result.status == 'success'){
	        		$('.' + wishNo).find('.heart').toggleClass('toggle').show().fadeToggle(1000),
	        		setTimeout(function(){
	        			$('.' + wishNo).find('.heart').toggleClass('toggle');  
					   },1000), 
	        		$('.' + wishNo).find('.undoheart').hide().fadeToggle(1000);
	        		
	        		numOfLike.text(Number(numOfLikeval)+1);
	        		
				}else{
					swal('좋아요 추가에 실패하였습니다.');
				}
			});
	});

	/* 좋아요 삭제 이벤트 */
	$(document).on('click', '.undoheart', function(){
		console.log('좋아요 취소이벤트 발생');
		var wishNo = $(this).closest('.item').find('.no').val();
		var uNo = $('#loginUser-no').text();
		var numOfLikeval = $(this).find("#likeAmount").text();
		var numOfLike = $(this).prev("div").find("#likeAmount");
		
		$.getJSON('/peekis/main/ajax/deleteLike.do', {wno : wishNo, uno : uNo}, function(resultObj) {
			var result = resultObj.ajaxResult;
			if(result.status == 'success'){
	    		$('.' + wishNo).find('.undoheart').toggleClass('toggle').show().fadeToggle(1000),
	    		setTimeout(function(){
	    			$('.' + wishNo).find('.undoheart').toggleClass('toggle');  
				   },1000), 
	    		$('.' + wishNo).find('.heart').hide().fadeToggle(1000);
	    		
	    		numOfLike.text(Number(numOfLikeval)-1);
	    		
			}else{
				swal('좋아요 삭제에 실패하였습니다.');
			}
		});
	});


	/* 게시글 담아가기 */
	$(document).on("click", ".plus", function(){
	var wishNo = $(this).closest('.item').find('.no').val();
	var uNo = $('#loginUser-no').text();
	if($(this).attr('status') == 'true'){
		swal("이미 담아가기 한 위시리스트입니다!", "한번만 담아기가 가능합니다", "error");
	}else{
		$.getJSON('/peekis/main/ajax/send.do', {wno : wishNo, uno : uNo}, 
			function( resultObj ) {
				$('.' + wishNo).find('.plus').attr('status',true);
				swal("담아가기 성공!", "해당 아이템을 담았습니다!", "success");
				console.log(resultObj);
			});
	}
	});


	/* 친구페이지로 넘어가기 */
	$(document).on('click', '.user_id', function (){
		var userNo = $(this).closest('.item').find('.uno').val();
		var loginUser = $('#loginUser-no').text();
		if(userNo == loginUser){
	    	location.href = contextRoot + "/view/myList/myList2.html";
		}else{
	    	location.href = contextRoot + "/view/user/user.html?fNo=" + userNo;
		}
	});
	
	
	
	
	$('#filters').on('click', 'button', function() {
		var filterValue = $(this).attr('data-filter');
		$container.isotope({
			filter : filterValue
		});
	});

	$(".btn-pref .btn").click( function() {
		$(".btn-pref .btn").removeClass("btn-orange").addClass("btn-default");
		$(this).removeClass("btn-default").addClass("btn-orange");
	});
	
	var didScroll;
	var lastScrollTop = 0;
	var delta = 5;
	var navbarHeight = $('footer').outerHeight();

	$(window).scroll(function(event){
	    didScroll = true;
	});

	setInterval(function() {
	    if (didScroll) {
	        hasScrolled();
	        didScroll = false;
	    }
	}, 250);

	function hasScrolled() {
	    var st = $(this).scrollTop();
	    
	    if(Math.abs(lastScrollTop - st) <= delta)
	        return;
	    
	    if (st > lastScrollTop && st > navbarHeight){
	        $('footer').removeClass('nav-down').addClass('nav-up');
	        $('#demoTop').show();
	        
	    } else {
	        if(st + $(window).height() < $(document).height()) {
	            $('footer').removeClass('nav-up').addClass('nav-down');
	        }
	    }
	    lastScrollTop = st;
	}


</script>
<!-- js -->
<script type="text/javascript" src="../../js/detail.js"></script>
</body>
</html>
